name: ImmortalWrt Builder

permissions:
  contents: write

on:
  repository_dispatch:
    types: [ "Source Code Update" ]
  workflow_dispatch:
    inputs:
      device:
        description: 'ç¼–è¯‘è®¾å¤‡åž‹å·'
        required: true
        type: choice
        default: '256M'
        options:
          - '256M'
          - '128M'
          - '128M-Ubootmod'
      commit:
        description: 'æŒ‡å®šæºç commitè¿›è¡Œç¼–è¯‘ï¼Œç•™ç©ºæ‹‰å–æœ€æ–°æºç '
        required: false
        type: string
        default: ''
      ssh:
        description: 'æ˜¯å¦æ‰§è¡Œ make menuconfig'
        required: false
        type: boolean
        default: false

env:
  DEVICE_INPUT: ${{ github.event.inputs.device || github.event.client_payload.device }}
  CCACHE_DIR: /workdir/.ccache
  CCACHE_MAXSIZE: 6G
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
  REPO_BRANCH: openwrt-24.10-6.6
  REPO_COMMIT: ${{ github.event.inputs.commit || '' }}
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  menuconfig:
    name: âš™ï¸ Menuconfig & Push
    if: github.event.inputs.ssh == 'true'
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ™Œ Checkout
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Init Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends libncurses-dev build-essential git wget python3 bzip2
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: ðŸªœ Clone source code
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --filter=blob:none openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: ðŸ”§ Set device variables
        run: |
          case "$DEVICE_INPUT" in
            "256M") echo "CONFIG_FILE=config/256m.config" >> $GITHUB_ENV ;;
            "128M") echo "CONFIG_FILE=config/128m.config" >> $GITHUB_ENV ;;
            "128M-Ubootmod") echo "CONFIG_FILE=config/128muboot.config" >> $GITHUB_ENV ;;
            *) echo "Unknown device: $DEVICE_INPUT" >&2; exit 1 ;;
          esac

      - name: ðŸ‘©â€ðŸ’» Copy previous config if exists
        run: |
          if [ -f "$GITHUB_WORKSPACE/${CONFIG_FILE}" ]; then
            echo "ðŸ“ Copying previous config to openwrt/.config"
            cp -f "$GITHUB_WORKSPACE/${CONFIG_FILE}" /workdir/openwrt/.config
          else
            echo "âš ï¸ No previous config found at $GITHUB_WORKSPACE/${CONFIG_FILE}"
          fi

      - name: âš™ï¸ Load custom feeds
        run: |
          set -e
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: ðŸ§¬ Update feeds
        run: cd openwrt && ./scripts/feeds update -a

      - name: ðŸª› Install feeds
        run: cd openwrt && ./scripts/feeds install -a

      - name: ðŸ§© Load custom configuration
        run: |
          set -e
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: âŒ¨ï¸ SSH connection to Menuconfig
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 15
          
      - name: ðŸ“¤ Push config to main branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          SRC="/workdir/openwrt/.config"
          DST="$GITHUB_WORKSPACE/${CONFIG_FILE}"

          echo "Source: $SRC"
          echo "Target: $DST"

          if [ ! -f "$SRC" ]; then
            echo "No .config found at $SRC. Nothing to do."
            exit 0
          fi

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨å¹¶æ‹·è´  
          mkdir -p "$(dirname "$DST")"   
          cp -f "$SRC" "$DST"   
          echo "Copied .config to $DST"   
 
          cd "$GITHUB_WORKSPACE"   
   
          git config user.name "github-actions[bot]"   
          git config user.email "github-actions[bot]@users.noreply.github.com"   
 
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´  
          git add "$CONFIG_FILE"   
          if git diff --cached --quiet; then  
            echo "No changes to commit."   
            exit 0  
          fi  
 
          # ç›´æŽ¥æŽ¨é€åˆ°ä¸»åˆ†æ”¯  
          git commit -m "Update OpenWrt config: ${CONFIG_FILE}"   
          git push origin HEAD:main

  build:
    name: ðŸ”¨ Build Firmware
    needs: menuconfig
    if: ${{ always() && (needs.menuconfig.result == 'success' || needs.menuconfig.result == 'skipped') }}
    runs-on: ubuntu-22.04
    
    steps:
      - name: ðŸ™Œ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: ðŸ› ï¸ Init Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ðŸ”§ Cleaning up disk space..."
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

          echo "ðŸ“¦ Installing dependencies..."
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

          echo "â° Setting timezone to $TZ"
          sudo timedatectl set-timezone "$TZ"

          sudo swapoff -a && sudo rm -f /mnt/swapfile
          export ROOT_FREE_KB=$(df --block-size=1024 --output=avail / | tail -1)
          export ROOT_LOOP_KB=$(expr $ROOT_FREE_KB - 1048576)
          export ROOT_LOOP_BYTES=$(expr $ROOT_LOOP_KB \* 1024)
          sudo fallocate -l $ROOT_LOOP_BYTES /root.img
          export ROOT_LOOP_DEVNAME=$(sudo losetup -Pf --show /root.img)
          sudo pvcreate -f $ROOT_LOOP_DEVNAME
          export MNT_FREE_KB=$(df --block-size=1024 --output=avail /mnt | tail -1)
          export MNT_LOOP_KB=$(expr $MNT_FREE_KB - 102400)
          export MNT_LOOP_BYTES=$(expr $MNT_LOOP_KB \* 1024)
          sudo fallocate -l $MNT_LOOP_BYTES /mnt/mnt.img
          export MNT_LOOP_DEVNAME=$(sudo losetup -Pf --show /mnt/mnt.img)
          sudo pvcreate -f $MNT_LOOP_DEVNAME
          sudo vgcreate vgstorage $ROOT_LOOP_DEVNAME $MNT_LOOP_DEVNAME
          sudo lvcreate -n lvstorage -l 100%FREE vgstorage
          export LV_DEVNAME=$(sudo lvscan | awk -F "'" '{print $2}')
          sudo mkfs.btrfs -L combinedisk $LV_DEVNAME
          sudo mount -o compress=zstd $LV_DEVNAME $GITHUB_WORKSPACE
          sudo chown -R runner:runner $GITHUB_WORKSPACE
          mkdir $GITHUB_WORKSPACE/tmp && chmod 777 $GITHUB_WORKSPACE/tmp
          sudo cp -rp /tmp/* $GITHUB_WORKSPACE/tmp
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

          echo "ðŸ’¾ Disk space after cleanup:"
          df -hT

      - name: ðŸªœ Clone source code
        working-directory: /workdir
        run: |
          echo "ðŸ“¥ Cloning $REPO_URL (branch: $REPO_BRANCH)"
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --filter=blob:none openwrt
          cd openwrt

          if [ -n "${REPO_COMMIT}" ]; then
            echo "ðŸ”€ Checking out specified commit $REPO_COMMIT"
            git fetch origin $REPO_COMMIT
            git checkout $REPO_COMMIT
          else
            echo "ðŸ†• Using latest commit on branch $REPO_BRANCH"
            git checkout $REPO_BRANCH
          fi

          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          echo "âœ… Source code cloned successfully"

      - name: ðŸ”§ Set device variables
        run: |
          case "$DEVICE_INPUT" in
            "256M")
              echo "CONFIG_FILE=config/256m.config" >> $GITHUB_ENV
              echo "FIRMWARE_NAME=256M" >> $GITHUB_ENV
              echo "DELETE_TAG_PATTERN=^256M-.*" >> $GITHUB_ENV
              ;;
            "128M")
              echo "CONFIG_FILE=config/128m.config" >> $GITHUB_ENV
              echo "FIRMWARE_NAME=128M" >> $GITHUB_ENV
              echo "DELETE_TAG_PATTERN=^128M-.*" >> $GITHUB_ENV
              ;;
            "128M-Ubootmod")
              echo "CONFIG_FILE=config/128muboot.config" >> $GITHUB_ENV
              echo "FIRMWARE_NAME=128M_Ubootmod" >> $GITHUB_ENV
              echo "DELETE_TAG_PATTERN=^128M_Ubootmod-.*" >> $GITHUB_ENV
              ;;
          esac

      - name: âš™ï¸ Load custom feeds
        run: |
          set -e
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: ðŸ§¬ Update feeds
        run: cd openwrt && ./scripts/feeds update -a

      - name: ðŸª› Install feeds
        run: cd openwrt && ./scripts/feeds install -a

      - name: ðŸ§© Load custom configuration
        run: |
          set -e
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: ðŸ“ Generate config hash for cache
        id: config-hash
        run: |
          cd openwrt
          make defconfig
          CONFIG_HASH=$(md5sum .config | awk '{print $1}')
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Config hash: $CONFIG_HASH"

      - name: âš™ï¸ Setup ccache cache
        uses: actions/cache@v4
        with:
          path: /workdir/.ccache
          key: ${{ runner.os }}-ccache-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}

      - name: âš™ï¸ Setup downloads cache
        uses: actions/cache@v4
        with:
          path: /workdir/openwrt/dl
          key: ${{ runner.os }}-openwrt-dl-${{ env.REPO_BRANCH }}-${{ steps.config-hash.outputs.hash }}

      - name: ðŸ”§ Configure ccache
        run: |
          ccache --set-config=max_size=$CCACHE_MAXSIZE
          ccache --set-config=cache_dir=$CCACHE_DIR
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache -z
          echo "âœ… ccache configured with max size: $CCACHE_MAXSIZE"

      - name: ðŸ•¹ï¸ Download packages
        id: package
        run: |
          cd openwrt
          echo "ðŸ“¦ Downloading packages..."
          make download -j$(nproc)
          echo "ðŸ” Checking for failed downloads..."
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ðŸ”® Compile the firmware
        id: compile
        run: |
          cd openwrt
          echo "ðŸ”¨ Starting compilation with $(nproc) threads"
          echo "CCACHE_DIR: $CCACHE_DIR"

          # é¦–å…ˆå°è¯•å¤šçº¿ç¨‹ç¼–è¯‘
          if make -j$(nproc) CC="ccache gcc" CXX="ccache g++"; then
            echo "âœ… Multi-threaded compilation succeeded"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Multi-threaded compilation failed, retrying with single thread and verbose output..."
            make -j1 V=s
            if [ $? -eq 0 ]; then
              echo "âœ… Single-threaded compilation succeeded"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Compilation failed"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # æ˜¾ç¤º ccache ç»Ÿè®¡
          echo "ðŸ“Š ccache statistics:"
          ccache -s

          # èŽ·å–è®¾å¤‡åç§°
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

          echo "ðŸ“± Device: $(cat DEVICE_NAME 2>/dev/null || echo 'unknown')"
          echo "ðŸ“… Build date: $(date +"%Y-%m-%d %H:%M:%S")"

      - name: ðŸ› ï¸ Check space usage
        if: (!cancelled())
        run: |
          echo "ðŸ’¾ Disk space usage:"
          df -hT
          echo ""
          echo "ðŸ“Š Build directory size:"
          du -sh /workdir/openwrt 2>/dev/null || echo "Unable to calculate"

      - name: ðŸª„ Upload bin directory
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin
          compression-level: 9

      - name: âŒš Organize files
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "ðŸ“‚ Firmware files:"
          ls -lh
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ðŸ“¢ Upload firmware directory
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}
          compression-level: 9

      - name: ðŸ“Œ Generate release tag
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          BUILD_TIME=$(date +"%Y%m%d-%H%M")
          RELEASE_TAG="${FIRMWARE_NAME}-${BUILD_TIME}"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

          cat > release.txt << EOF
          ## ðŸ“¦ ImmortalWrt Firmware Release

          **ðŸ·ï¸ Release:** $RELEASE_TAG
          **ðŸŒ¿ Branch:** $REPO_BRANCH
          **ðŸ“± Device:** $(cat openwrt/DEVICE_NAME 2>/dev/null || echo 'N/A')
          **ðŸ“… Build Date:** $(date +"%Y-%m-%d %H:%M:%S")
          **ðŸ”¨ Compiler:** GCC with ccache

          ## ðŸ“¥ Download

          Download the firmware files from the assets below.

          ---

          Built with â¤ï¸ using [GitHub Actions](https://github.com/features/actions)
          EOF

          echo "status=success" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload firmware to release
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*sysupgrade.bin

      - name: ðŸš§ Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep_minimum_runs: 9

